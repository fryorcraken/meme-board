<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>/b/ - Meme Board</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #eef2ff;
            color: #000;
            line-height: 1.4;
        }

        .header {
            background-color: #d6daf0;
            border-bottom: 1px solid #b7c5d9;
            padding: 10px;
            text-align: center;
        }

        .header h1 {
            color: #af0a0f;
            font-size: 24px;
            font-weight: bold;
        }

        .header .subtitle {
            color: #789922;
            font-size: 14px;
            margin-top: 5px;
        }

        .controls {
            background-color: #d6daf0;
            border-bottom: 1px solid #b7c5d9;
            padding: 15px;
            text-align: center;
        }

        .upload-btn {
            background-color: #d6daf0;
            border: 1px solid #b7c5d9;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .upload-btn:hover {
            background-color: #c5cae4;
        }

        #fileInput {
            display: none;
        }

        .board {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .image-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .post {
            background-color: #f0e0d6;
            border: 1px solid #d9bfb7;
            border-radius: 3px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .post:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .post-header {
            background-color: #d6daf0;
            padding: 8px 12px;
            border-bottom: 1px solid #b7c5d9;
            font-size: 12px;
        }

        .post-number {
            color: #000080;
            font-weight: bold;
        }

        .post-time {
            color: #789922;
            float: right;
        }

        .post-image {
            width: 100%;
            height: auto;
            display: block;
            max-height: 300px;
            object-fit: cover;
        }

        .post-filename {
            padding: 8px 12px;
            font-size: 11px;
            color: #789922;
            background-color: #f0e0d6;
            word-break: break-all;
        }

        .empty-state {
            text-align: center;
            color: #789922;
            font-size: 16px;
            margin-top: 50px;
        }



        .post-magnet {
            padding: 8px 12px;
            font-size: 10px;
            color: #000080;
            background-color: #f0e0d6;
            border-top: 1px solid #d9bfb7;
            word-break: break-all;
            cursor: pointer;
        }

        .post-magnet:hover {
            background-color: #e8d8c8;
        }

        .torrent-status {
            padding: 4px 12px;
            font-size: 10px;
            color: #789922;
            background-color: #f0e0d6;
            font-style: italic;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.5/dist/protobuf.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>/b/ - Meme Board</h1>
        <div class="subtitle">Random - Images Only</div>
    </div>

    <div class="controls">
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
            Choose File
        </button>
        <input type="file" id="fileInput" accept="image/*" multiple>
        <span id="fileCount"></span>
        <span id="wakuStatus" style="margin-left: 20px; color: #789922; font-size: 12px;">Waku: Connecting...</span>
    </div>

    <div class="board">
        <div class="image-wall" id="imageWall">
            <div class="empty-state" id="emptyState">
                No images posted yet. Be the first to post!
            </div>
        </div>
    </div>

    <script type="module">
        import {
            createLightNode,
        } from 'https://unpkg.com/@waku/sdk@0.0.34-aac044f.0/bundle/index.js';
        
        let postCounter = 1;
        let images = [];
        let torrentClient = new WebTorrent();
        let wakuClient = null;
        let memeProtobuf = null;
        let wakuEncoder = null;
        let wakuDecoder = null;
        
        const CONTENT_TOPIC = '/meme-board/1/images/proto';
        
        // Define protobuf schema
        const protoSchema = {
            "nested": {
                "MemeMessage": {
                    "fields": {
                        "magnetUri": {
                            "type": "string",
                            "id": 1
                        },
                        "filename": {
                            "type": "string", 
                            "id": 2
                        },
                        "filesize": {
                            "type": "uint64",
                            "id": 3
                        },
                        "timestamp": {
                            "type": "uint64",
                            "id": 4
                        },
                        "postId": {
                            "type": "uint32",
                            "id": 5
                        }
                    }
                }
            }
        };

        const fileInput = document.getElementById('fileInput');
        const imageWall = document.getElementById('imageWall');
        const emptyState = document.getElementById('emptyState');
        const fileCount = document.getElementById('fileCount');

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToBoard(e.target.result, file.name, file.size, file);
                    };
                    reader.readAsDataURL(file);
                }
            });

            fileInput.value = '';
        }

        function addImageToBoard(imageSrc, filename, filesize, file) {
            const post = document.createElement('div');
            post.className = 'post';
            post.dataset.postId = postCounter;

            const now = new Date();
            const timeString = now.toLocaleString();
            const filesizeKB = Math.round(filesize / 1024);

            post.innerHTML = `
                <div class="post-header">
                    <span class="post-number">No.${postCounter}</span>
                    <span class="post-time">${timeString}</span>
                </div>
                <img class="post-image" src="${imageSrc}" alt="${filename}">
                <div class="post-filename">${filename} (${filesizeKB} KB)</div>
                <div class="torrent-status" id="status-${postCounter}">Creating torrent...</div>
                <div class="post-magnet" id="magnet-${postCounter}" style="display: none;" onclick="copyToClipboard(this.textContent)">
                    Click to copy magnet URI
                </div>
            `;

            if (emptyState.style.display !== 'none') {
                emptyState.style.display = 'none';
            }

            imageWall.appendChild(post);
            
            images.push({
                id: postCounter,
                src: imageSrc,
                filename: filename,
                filesize: filesize,
                timestamp: now,
                file: file
            });
            
            // Add timestamp to post element for ordering
            post.dataset.timestamp = now.getTime();

            if (file) {
                createTorrent(file, postCounter);
            }

            postCounter++;
            updateFileCount();
        }



        function updateFileCount() {
            if (images.length > 0) {
                fileCount.textContent = `${images.length} image${images.length !== 1 ? 's' : ''} posted`;
            } else {
                fileCount.textContent = '';
            }
        }

        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            document.body.style.backgroundColor = '#e8ecf7';
        });

        document.addEventListener('dragleave', function(e) {
            if (e.clientX === 0 && e.clientY === 0) {
                document.body.style.backgroundColor = '#eef2ff';
            }
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
            document.body.style.backgroundColor = '#eef2ff';
            
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImageToBoard(e.target.result, file.name, file.size, file);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function createTorrent(file, postId) {
            const statusEl = document.getElementById(`status-${postId}`);
            const magnetEl = document.getElementById(`magnet-${postId}`);
            
            statusEl.textContent = 'Creating torrent...';
            
            torrentClient.seed(file, function (torrent) {
                statusEl.textContent = `Seeding (${torrent.numPeers} peers)`;
                magnetEl.textContent = torrent.magnetURI;
                magnetEl.style.display = 'block';
                magnetEl.title = 'Click to copy magnet URI';
                
                // Send magnet link via Waku
                sendMagnetViaWaku(torrent.magnetURI, file.name, file.size, postId);
                
                torrent.on('wire', function () {
                    statusEl.textContent = `Seeding (${torrent.numPeers} peers)`;
                });
                
                torrent.on('upload', function () {
                    statusEl.textContent = `Seeding (${torrent.numPeers} peers) - ${formatBytes(torrent.uploaded)} uploaded`;
                });
            });
        }

        async function sendMagnetViaWaku(magnetUri, filename, filesize, postId, client = wakuClient, encoder = wakuEncoder) {
            try {
                if (!client || !encoder) {
                    console.log('Waku client or encoder not initialized');
                    return;
                }
                
                const timestamp = Date.now();
                const encodedMessage = encodeMessage(magnetUri, filename, filesize, timestamp, postId);
                
                console.log('Sending magnet via Waku:', { magnetUri, filename, filesize, timestamp, postId });
                
                await client.lightPush.send(encoder, {
                    payload: encodedMessage
                });
                
                console.log('Successfully sent magnet via Waku');
                
            } catch (error) {
                console.error('Failed to send magnet via Waku:', error);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                const notification = document.createElement('div');
                notification.textContent = 'Magnet URI copied to clipboard!';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #789922;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    z-index: 1000;
                    font-size: 14px;
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }).catch(function() {
                alert('Failed to copy magnet URI');
            });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize protobuf
        function initProtobuf() {
            const root = protobuf.Root.fromJSON(protoSchema);
            memeProtobuf = root.lookupType("MemeMessage");
        }

        // Encode message to protobuf
        function encodeMessage(magnetUri, filename, filesize, timestamp, postId) {
            const message = {
                magnetUri: magnetUri,
                filename: filename,
                filesize: filesize,
                timestamp: timestamp,
                postId: postId
            };
            
            const errMsg = memeProtobuf.verify(message);
            if (errMsg) {
                throw Error(errMsg);
            }
            
            const messageObj = memeProtobuf.create(message);
            return memeProtobuf.encode(messageObj).finish();
        }

        // Decode protobuf message
        function decodeMessage(buffer) {
            try {
                const message = memeProtobuf.decode(buffer);
                return memeProtobuf.toObject(message, {
                    longs: String,
                    enums: String,
                    bytes: String
                });
            } catch (error) {
                console.error('Failed to decode message:', error);
                return null;
            }
        }

        async function initWaku() {
            try {
                console.log('Initializing Waku client...');
                wakuClient = await createLightNode({
                    defaultBootstrap: true
                });
                
                // Listen for connection events
                wakuClient.events.addEventListener("waku:connection", (event) => {
                    console.log('Waku connection event:', event.detail); // true if connected, false if disconnected
                    console.log(`Waku connection event: ${event.detail}`)
                    if (event.detail) {
                        updateWakuStatus('Connected');
                    } else {
                        updateWakuStatus('Disconnected');
                    }
                });
                
                await wakuClient.start();
                console.log('Waku client started successfully');
                updateWakuStatus('Started - Connecting to node...');
                
                // Create encoder and decoder for messages
                wakuEncoder = wakuClient.createEncoder({ contentTopic: CONTENT_TOPIC });
                wakuDecoder = wakuClient.createDecoder({ contentTopic: CONTENT_TOPIC });
                console.log('Created Waku encoder and decoder');
                
                // Subscribe to incoming messages
                await subscribeToMessages();
                
                // Dial the specific Waku node
                const nodeAddress = '/dns4/waku.fryorcraken.xyz/tcp/8000/wss/p2p/16Uiu2HAmMRvhDHrtiHft1FTUYnn6cVA8AWVrTyLUayJJ3MWpUZDB';
                try {
                    console.log('Dialing Waku node:', nodeAddress);
                    await wakuClient.dial(nodeAddress);
                    console.log('Successfully connected to fryorcraken Waku node');
                } catch (dialError) {
                    console.error('Failed to dial Waku node:', dialError);
                }
                
            } catch (error) {
                console.error('Failed to initialize Waku:', error);
            }
        }

        async function subscribeToMessages() {
            try {
                console.log('Subscribing to Waku messages...');
                
                const subscription = await wakuClient.filter.subscribe(wakuDecoder, (message) => {
                    console.log('Received Waku message:', message);
                    handleIncomingMessage(message);
                });
                
                console.log('Successfully subscribed to messages');
            } catch (error) {
                console.error('Failed to subscribe to messages:', error);
            }
        }

        function handleIncomingMessage(wakuMessage) {
            try {
                if (!wakuMessage.payload) {
                    console.log('Message has no payload');
                    return;
                }
                
                const decodedMessage = decodeMessage(wakuMessage.payload);
                if (!decodedMessage) {
                    console.log('Failed to decode message');
                    return;
                }
                
                console.log('Decoded message:', decodedMessage);
                
                // Add received message to board
                addReceivedImageToBoard(decodedMessage);
                
            } catch (error) {
                console.error('Error handling incoming message:', error);
            }
        }

        function updateWakuStatus(status) {
            const statusElement = document.getElementById('wakuStatus');
            if (statusElement) {
                statusElement.textContent = `Waku: ${status}`;
            }
        }

        function addReceivedImageToBoard(messageData) {
            try {
                // Check if we already have this post
                const existingPost = document.querySelector(`[data-post-id="${messageData.postId}"]`);
                if (existingPost) {
                    console.log('Post already exists:', messageData.postId);
                    return;
                }
                
                const post = document.createElement('div');
                post.className = 'post';
                post.dataset.postId = messageData.postId;
                post.dataset.timestamp = messageData.timestamp;
                
                const date = new Date(parseInt(messageData.timestamp));
                const timeString = date.toLocaleString();
                const filesizeKB = Math.round(parseInt(messageData.filesize) / 1024);
                
                post.innerHTML = `
                    <div class="post-header">
                        <span class="post-number">No.${messageData.postId}</span>
                        <span class="post-time">${timeString}</span>
                    </div>
                    <div style="padding: 20px; text-align: center; background: #e8e8e8; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 10px;">🖼️</div>
                        <div>Image available via torrent</div>
                        <div style="font-size: 12px; margin-top: 5px;">Click magnet link to download</div>
                    </div>
                    <div class="post-filename">${messageData.filename} (${filesizeKB} KB)</div>
                    <div class="torrent-status">Received via Waku</div>
                    <div class="post-magnet" onclick="copyToClipboard(this.textContent)">${messageData.magnetUri}</div>
                `;
                
                if (emptyState.style.display !== 'none') {
                    emptyState.style.display = 'none';
                }
                
                // Insert post in chronological order
                insertPostInOrder(post);
                
                // Try to download the torrent to show the actual image
                tryDownloadTorrent(messageData.magnetUri, messageData.postId);
                
                console.log('Added received image to board:', messageData.postId);
                
            } catch (error) {
                console.error('Error adding received image to board:', error);
            }
        }

        function insertPostInOrder(newPost) {
            const newTimestamp = parseInt(newPost.dataset.timestamp);
            const existingPosts = Array.from(imageWall.querySelectorAll('.post'));
            
            let insertIndex = existingPosts.length;
            for (let i = 0; i < existingPosts.length; i++) {
                const existingTimestamp = parseInt(existingPosts[i].dataset.timestamp || '0');
                if (newTimestamp > existingTimestamp) {
                    insertIndex = i;
                    break;
                }
            }
            
            if (insertIndex === existingPosts.length) {
                imageWall.appendChild(newPost);
            } else {
                imageWall.insertBefore(newPost, existingPosts[insertIndex]);
            }
        }

        function tryDownloadTorrent(magnetUri, postId) {
            try {
                torrentClient.add(magnetUri, function (torrent) {
                    console.log('Started downloading torrent for post:', postId);
                    
                    torrent.files.forEach(function (file) {
                        if (file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                            file.getBlobURL(function (err, url) {
                                if (!err && url) {
                                    // Replace placeholder with actual image
                                    const post = document.querySelector(`[data-post-id="${postId}"]`);
                                    if (post) {
                                        const placeholder = post.querySelector('div[style*="background: #e8e8e8"]');
                                        if (placeholder) {
                                            placeholder.outerHTML = `<img class="post-image" src="${url}" alt="${file.name}">`;
                                        }
                                    }
                                }
                            });
                        }
                    });
                });
            } catch (error) {
                console.log('Could not download torrent:', error);
            }
        }

        window.addEventListener('load', function() {
            initProtobuf();
            initWaku();
        });
    </script>
</body>
</html>